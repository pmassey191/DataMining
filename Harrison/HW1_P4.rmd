---
title: "HW1_P4"
author: "Harrison Snell"
date: "2/9/2022"
output: md_document
---

## Problem 4

In this problem, we want to find the optimal value of K in our KNN regressions for each trim. In the chart of RMSE versus K for each trim, there is a line for the RMSE of a linear benchmark, as well as a quadratic benchmark.

```{r, echo=FALSE,results=FALSE,warning=FALSE,message=FALSE}
library(tidyverse)
library(mosaic)
library(ggplot2)
library(rsample)
library(caret)
library(modelr)
library(parallel)
library(foreach)

sclass <- read.csv("~/School/University of Texas-Austin/Classes/Data Mining/Data/sclass.csv")

```


```{r, echo=FALSE,results=FALSE,warning=FALSE,message=FALSE}

sclass_clean = sclass %>%
  select(trim, mileage, price)%>%
  filter(trim=='65 AMG' | trim=='350')

sclass_350 = sclass_clean%>%
  filter(trim=='350')

sclass350_split = initial_split(sclass_350, prop = 0.8)
sclass350_train = training(sclass350_split)
sclass350_test = testing(sclass350_split)

lm1_350 = lm(price ~ mileage, data=sclass350_train)
lm2_350 = lm(price ~ poly(mileage, 2), data=sclass350_train)

linear_bench_350 = rmse(lm1_350, sclass350_test)
quad_bench_350 = rmse(lm2_350, sclass350_test)

knn_350 = foreach(i = 2:100, .combine='rbind') %do% {
  err = rmse(knnreg(price ~ mileage, data=sclass350_train, k=i),sclass350_test)
  }%>% as.data.frame()

knn_350 = data.frame(knn_350,2:100)

knn_350 = knn_350%>%
  mutate(RMSE = V1, k = X2.100)%>%
  select(RMSE,k)

ggplot(knn_350)+
  theme_classic()+
  geom_line(aes(y=RMSE,x=k,color='dark green'))+
  geom_hline(aes(yintercept=quad_bench_350,color='blue'))+
  geom_hline(aes(yintercept=linear_bench_350,color='red'))+
  labs(title = "350 Trim: RMSE for Different K Values\n", x = "K", y = "RMSE") +
  scale_color_manual(labels = c("Quadratic RMSE","KNN RMSE","Linear RMSE"),
                     values = c('blue', 'dark green','red'))+
  theme(legend.title = element_blank())

optimal_350 = knn_350 %>%
  arrange(RMSE)

optk_350 = as.numeric(optimal_350[1,2])

knn350_optk <- knnreg(price ~ mileage, data=sclass350_train, k=optk_350)

sclass_350_test = sclass350_test %>%
  mutate(price_pred = predict(knn350_optk, sclass350_test))

ggplot(data = sclass_350_test) +
  theme_classic()+
  ggtitle(paste("350 Trim: Line of Fit for K=",optk_350, sep = ""))+
  geom_point(mapping = aes(x = mileage, y = price), alpha=0.2) + 
  geom_line(aes(x = mileage, y = price_pred), color='red', size=1.5)



sclass_AMG = sclass_clean%>%
  filter(trim=='65 AMG')

sclassAMG_split = initial_split(sclass_AMG, prop = 0.8)
sclassAMG_train = training(sclassAMG_split)
sclassAMG_test = testing(sclassAMG_split)

lm1_AMG = lm(price ~ mileage, data=sclassAMG_train)
lm2_AMG = lm(price ~ poly(mileage, 2), data=sclassAMG_train)

linear_bench_AMG = rmse(lm1_AMG, sclassAMG_test)
quad_bench_AMG = rmse(lm2_AMG, sclassAMG_test)

knn_AMG = foreach(i = 2:100, .combine='rbind') %do% {
  err = rmse(knnreg(price ~ mileage, data=sclassAMG_train, k=i),sclassAMG_test)
}%>% as.data.frame()

knn_AMG = data.frame(knn_AMG,2:100)

knn_AMG = knn_AMG%>%
  mutate(RMSE = V1, k = X2.100)%>%
  select(RMSE,k)

ggplot(knn_AMG)+
  theme_classic()+
  geom_line(aes(y=RMSE,x=k,color='dark green'))+
  geom_hline(aes(yintercept=quad_bench_AMG,color='blue'))+
  geom_hline(aes(yintercept=linear_bench_AMG,color='red'))+
  labs(title = "AMG Trim: RMSE for Different K Values\n", x = "K", y = "RMSE") +
  scale_color_manual(labels = c("Quadratic RMSE","KNN RMSE","Linear RMSE"),
                     values = c('blue', 'dark green','red'))+
  theme(legend.title = element_blank())

optimal_AMG = knn_AMG %>%
  arrange(RMSE)

optk_AMG = as.numeric(optimal_AMG[1,2])

knnAMG_optk <- knnreg(price ~ mileage, data=sclassAMG_train, k=optk_AMG)

sclass_AMG_test = sclassAMG_test %>%
  mutate(price_pred = predict(knnAMG_optk, sclassAMG_test))

ggplot(data = sclass_AMG_test) +
  theme_classic()+
  ggtitle(paste("AMG Trim: Line of Fit for K=",optk_AMG, sep = ""))+
  geom_point(mapping = aes(x = mileage, y = price), alpha=0.2) + 
  geom_line(aes(x = mileage, y = price_pred), color='red', size=1.5)


```
From the 350 Trim chart of RMSE versus K, we see that the RMSE bottoms out at ```{r} optk_350```, as such the line of fit against the test data is for that K value. Similarly we have a minimal RMSE and line of fit for k=```{r} optk_AMG```.

